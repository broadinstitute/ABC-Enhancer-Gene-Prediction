import os
import pandas as pd
import hashlib
import numpy as np
from snakemake.utils import min_version
min_version("7.0")

configfile: "config/config.yaml"
conda: "mamba"

include: "rules/utils.smk"
config = convert_reference_files(config)
RESULTS_DIR = config['predictions_results_dir']
## Load biosamples and hic_hash dictionary
HIC_COLUMNS = ["HiC_dir", "HiC_type", "HiC_resolution", "HiC_gamma", "HiC_scale"]
BIOSAMPLES_CONFIG = load_biosamples_config(config)
HIC_HASHES = configure_hic_hashes(BIOSAMPLES_CONFIG)
SCRIPTS_DIR = os.path.join(config["ABC_DIR_PATH"], "workflow/scripts")
include: "rules/macs2.smk"
include: "rules/candidate_regions.smk"
include: "rules/neighborhoods.smk"
include: "rules/write_powerlaw_params.smk"
include: "rules/predictions.smk"
include: "rules/qc.smk"

## overall rule to run pipeline

filtered_prediction_file_format = determine_filtered_prediction_file_format(config)

rule all:
	input:
		allPutative = expand(
			os.path.join(RESULTS_DIR, "{biosample}", "Predictions", "EnhancerPredictionsAllPutative.tsv.gz"), biosample=BIOSAMPLES_CONFIG["biosample"]
		),
		enhPredictionsFull = expand(
			os.path.join(RESULTS_DIR, "{biosample}", "Predictions", f"EnhancerPredictionsFull_{filtered_prediction_file_format}.tsv"), biosample=BIOSAMPLES_CONFIG["biosample"]
		),
		qcPlots = expand(
			os.path.join(RESULTS_DIR, "{biosample}", "Metrics", f"QCSummary_{filtered_prediction_file_format}.tsv"), biosample=BIOSAMPLES_CONFIG["biosample"]
		)

